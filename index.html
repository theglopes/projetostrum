<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strum - Loja</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .catalog-section {
            margin: 96px auto 140px;
            max-width: 1180px;
            padding: 0 24px 72px;
        }
        .catalog-section__header {
            text-align: center;
            margin-bottom: 32px;
        }
        .catalog-section__header h3 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .catalog-section__header p {
            color: #a0a0a0;
            font-size: 14px;
            max-width: 560px;
            margin: 0 auto;
        }
        .catalog-close-btn {
            margin-top: 18px;
            padding: 10px 20px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(0, 0, 0, 0.35);
            color: #f5f5f5;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        }
        .catalog-close-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 10px 22px rgba(0, 0, 0, 0.28);
        }
        .catalog-empty {
            font-size: 15px;
            color: #9c9c9c;
            margin: 0 auto 18px;
            text-align: center;
        }
        .catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 24px;
        }
        .catalog-card {
            background: linear-gradient(180deg, rgba(39, 39, 39, 0.85), rgba(22, 22, 22, 0.92));
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .catalog-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 18px 38px rgba(0, 0, 0, 0.35);
        }
        .catalog-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: #101010;
        }
        .catalog-card__body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
        }
        .catalog-card__title {
            font-size: 18px;
            font-weight: 600;
        }
        .catalog-card__price {
            font-size: 16px;
            color: #a65cff;
        }
        .catalog-card__actions {
            margin-top: auto;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .catalog-card__action {
            flex: 1 1 auto;
            text-align: center;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }
        .catalog-card__add {
            background: linear-gradient(135deg, #9f52ff, #5d2cff);
            color: #fff;
        }
        .catalog-card__add:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(159, 82, 255, 0.32);
        }
        .catalog-card__delete {
            background: transparent;
            border-color: rgba(255, 107, 107, 0.6);
            color: #ff6b6b;
        }
        .catalog-card__delete:hover {
            background: rgba(255, 107, 107, 0.12);
        }
        @media (max-width: 600px) {
            .catalog-card img {
                height: 160px;
            }
            .catalog-card__body {
                padding: 16px;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="header-top">
            <div class="logo">
                <img src="css/Strum Logo Sem Fundo.png" alt="Logo Strum">
            </div>
        </div>

        <nav class="header-bottom">
            <div class="nav-links">
                <a href="index.html" aria-current="page">LOJA</a>
                <a href="comunidade.html">COMUNIDADE</a>
                <a href="sobre.html">SOBRE</a>
                <a href="suporte.html">SUPORTE</a>
                <a href="biblioteca.html">MINHA BIBLIOTECA</a>
            </div>
            <div class="nav-actions">
                <button type="button" class="nav-action icon-cart" aria-label="Abrir carrinho">
                    Carrinho
                    <span class="cart-badge hidden" id="cart-badge">0</span>
                </button>
                <button type="button" class="nav-action icon-login" id="btn-login" aria-haspopup="dialog">Login</button>
                <div class="nav-user hidden" id="nav-user" aria-live="polite">
                    <span id="nav-user-gamertag"></span>
                    <a href="perfil.html" class="nav-action nav-profile" id="btn-profile">Perfil</a>
                    <button type="button" class="nav-action nav-logout" id="btn-logout">Sair</button>
                </div>
            </div>
        </nav>
</header>
    <main>
        <div class="banner"><img src="css/Imagens/PROMOÇÃO DE FÉRIAS 01122025 - 01022026.png"></div>

        <section class="destaques">
            <h2>DESTAQUES <span class="ver-mais">VER MAIS</span></h2>
            <div class="grid">
                <div class="card grande d1">
                    <img src="css/Imagens/grand-theft-auto-6.png" alt="Grand Theft Auto 6">
                    <div class="card-overlay">
                        <div class="overlay-title">Grand Theft Auto 6</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d2">
                    <img src="css/Imagens/metal-gear-solid-v-the-phantom-pain.jpg" alt="Metal Gear Solid V: The Phantom Pain">
                    <div class="card-overlay">
                        <div class="overlay-title">Metal Gear Solid V: The Phantom Pain</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d3">
                    <img src="css/Imagens/alan-wake-2.jpeg" alt="Alan Wake 2">
                    <div class="card-overlay">
                        <div class="overlay-title">Alan Wake 2</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d4">
                    <img src="css/Imagens/assassins-creed-mirage.png" alt="Assassin's Creed Mirage">
                    <div class="card-overlay">
                        <div class="overlay-title">Assassin's Creed Mirage</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d5">
                    <img src="css/Imagens/dark-souls-remastered.png" alt="Dark Souls Remastered">
                    <div class="card-overlay">
                        <div class="overlay-title">Dark Souls Remastered</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="jogados">
            <h2>MAIS JOGADOS NO MOMENTO</h2>
            <div class="cards">
                <div class="card"><img src="css/Imagens/cyberpunk-2077.jpg"></div>
                <div class="card"><img src="css/Imagens/dying-light-2-stay-human.jpeg"></div>
                <div class="card"><img src="css/Imagens/detroit-become-human.jpg"></div>
                <div class="card"><img src="css/Imagens/god-of-war.jpeg"></div>
            </div>
        </section>

        <section class="lancamentos">
            <h2>LANAÇAMENTOS</h2>
            <div class="cards">
                <div class="card"><img src="css/Imagens/elden-ring.png"></div>
                <div class="card"><img src="css/Imagens/hogwarts-legacy.png"></div>
                <div class="card"><img src="css/Imagens/hades.jpg"></div>
                <div class="card"><img src="css/Imagens/grand-theft-auto-san-andreas.jpg"></div>
            </div>
        </section>

        <section class="novidades">
            <h2>NOVIDADES</h2>
            <div class="card grande"><img src="css/Imagens/Os jogos mais aguardados de 2026!.png"></div>
            <div class="cards">
                <div class="card"><img src="css/Imagens/hollow-knight.jpg"></div>
                <div class="card"><img src="css/Imagens/resident-evil-4.png"></div>
                <div class="card"><img src="css/Imagens/red-dead-redemption-2.jpg"></div>
                <div class="card"><img src="css/Imagens/the-last-of-us-part-1.png"></div>
            </div>
        </section>

        <section class="catalog-section hidden" id="catalog-section" aria-hidden="true">
            <div class="catalog-section__header">
                <h3>Catálogo completo</h3>
                <p>Veja todos os jogos cadastrados pela comunidade e pela equipe da Strum.</p>
                <button type="button" class="catalog-close-btn" id="catalog-close-btn">Fechar catálogo</button>
            </div>
            <p id="catalog-empty" class="catalog-empty hidden">Nenhum jogo cadastrado ainda.</p>
            <div id="catalog-grid" class="catalog-grid" aria-live="polite"></div>
        </section>

    </main>

    <div class="auth-overlay hidden" id="auth-overlay" aria-hidden="true">
        <div class="auth-dialog" role="dialog" aria-labelledby="auth-title">
            <button type="button" class="auth-close" id="auth-close" aria-label="Fechar janela de login">&times;</button>
            <h3 id="auth-title">Entrar</h3>
            <div class="auth-tabs">
                <button type="button" class="auth-tab active" data-auth-tab="login">Entrar</button>
                <button type="button" class="auth-tab" data-auth-tab="register">Criar conta</button>
            </div>
            <form class="auth-form" id="login-form">
                <label for="login-email">E-mail</label>
                <input type="email" id="login-email" name="email" placeholder="email@exemplo.com" required>
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" name="password" placeholder="Sua senha" required>
                <button type="submit" class="auth-submit">Entrar</button>
            </form>
            <form class="auth-form hidden" id="register-form">
                <label for="register-email">E-mail</label>
                <input type="email" id="register-email" name="email" placeholder="email@exemplo.com" required>
                <label for="register-gamertag">Gamertag</label>
                <input type="text" id="register-gamertag" name="gamertag" minlength="3" maxlength="20" pattern="[A-Za-z0-9._-]{3,20}" placeholder="strum_player" required>
                <label for="register-password">Senha</label>
                <input type="password" id="register-password" name="password" placeholder="Crie uma senha" minlength="4" required>
                <button type="submit" class="auth-submit">Criar conta</button>
            </form>
            <div class="auth-feedback" id="auth-feedback" role="status" aria-live="assertive"></div>
        </div>
    </div>
    <div class="toast" id="toast">
        <img src="css/Strum Logo Sem Fundo.png" alt="Strum">
        <span>Adicionado com sucesso ao seu carrinho</span>
    </div>

    <div class="cart-overlay" id="cart-overlay"></div>
    <aside class="cart-drawer" id="cart-drawer" aria-hidden="true" aria-label="Carrinho">
        <div class="cart-header">
            <h3>Seu Carrinho</h3>
            <span class="cart-close" id="cart-close">🛒</span>
        </div>
        <div class="cart-items" id="cart-items">
            <div class="cart-empty">Seu carrinho esta vazio.</div>
        </div>
        <div class="cart-footer">
            <div class="cart-total"><span>Total</span><strong id="cart-total">R$ 0,00</strong></div>
            <div class="cart-actions">
                <button class="btn" id="cart-clear">Esvaziar</button>
                <button class="btn btn-primary" id="cart-checkout">Pagar</button>
            </div>
        </div>
    </aside>

    <div class="checkout-modal" id="checkout-modal" aria-hidden="true">
        <div class="checkout-dialog" role="dialog" aria-modal="true" aria-labelledby="checkout-title">
            <button type="button" class="checkout-close" id="checkout-close" aria-label="Fechar pagamento">×</button>
            <h3 id="checkout-title">Pagamento seguro</h3>
            <p class="checkout-subtitle">Finalize seu pedido informando os dados do cartão. Nenhuma informação sensível é armazenada.</p>
            <div class="checkout-summary">
                <div class="checkout-total">
                    <span>Total da compra</span>
                    <strong id="checkout-total">R$ 0,00</strong>
                </div>
                <ul class="checkout-items" id="checkout-items"></ul>
            </div>
            <form class="checkout-form" id="checkout-form" novalidate>
                <div class="form-row">
                    <label for="checkout-card-name">Nome impresso no cartão</label>
                    <input type="text" id="checkout-card-name" name="cardName" placeholder="Nome do titular" autocomplete="cc-name" required>
                </div>
                <div class="form-row">
                    <label for="checkout-card-number">Número do cartão</label>
                    <input type="text" id="checkout-card-number" name="cardNumber" inputmode="numeric" autocomplete="cc-number" placeholder="0000 0000 0000 0000" maxlength="23" required>
                </div>
                <div class="form-row split">
                    <div>
                        <label for="checkout-expiry">Validade (MM/AA)</label>
                        <input type="text" id="checkout-expiry" name="cardExpiry" inputmode="numeric" autocomplete="cc-exp" placeholder="08/28" maxlength="5" required>
                    </div>
                    <div>
                        <label for="checkout-cvv">CVV</label>
                        <input type="password" id="checkout-cvv" name="cardCvv" inputmode="numeric" autocomplete="cc-csc" placeholder="123" maxlength="4" required>
                    </div>
                </div>
                <div class="form-row">
                    <label for="checkout-cpf">CPF do titular (opcional)</label>
                    <input type="text" id="checkout-cpf" name="cardCpf" inputmode="numeric" placeholder="000.000.000-00" maxlength="14">
                </div>
                <p class="checkout-feedback hidden" id="checkout-feedback" role="alert"></p>
                <div class="checkout-actions">
                    <button type="button" class="btn btn-secondary" id="checkout-cancel">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="checkout-submit">Confirmar pagamento</button>
                </div>
                <small class="checkout-safe-note">Os dados acima são utilizados apenas durante esta simulação de pagamento e não ficam salvos.</small>
            </form>
        </div>
    </div>

    <footer>
        © 2025 Strum LTDA. Todos os direitos reservados.
    </footer>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = 'http://localhost:8000';
            const CART_KEY = 'cart';
            const TOKEN_KEY = 'strum_token';
            const LIBRARY_KEY = 'strum_library';
            const GAMERTAG_REGEX = /^[A-Za-z0-9._-]{3,20}$/;

            let backendGames = [];
            const gameIndex = new Map();
            let currentUser = null;
            let checkoutSession = null;

            const els = {
                cartDrawer: document.getElementById('cart-drawer'),
                cartOverlay: document.getElementById('cart-overlay'),
                cartClose: document.getElementById('cart-close'),
                cartItems: document.getElementById('cart-items'),
                cartTotal: document.getElementById('cart-total'),
                cartClear: document.getElementById('cart-clear'),
                cartCheckout: document.getElementById('cart-checkout'),
                cartBadge: document.getElementById('cart-badge'),
                navCart: document.querySelector('.icon-cart'),
                loginBtn: document.getElementById('btn-login'),
                logoutBtn: document.getElementById('btn-logout'),
                profileLink: document.getElementById('btn-profile'),
                navUser: document.getElementById('nav-user'),
                navUserGamertag: document.getElementById('nav-user-gamertag'),
                authOverlay: document.getElementById('auth-overlay'),
                authClose: document.getElementById('auth-close'),
                authTabs: document.querySelectorAll('.auth-tab'),
                loginForm: document.getElementById('login-form'),
                registerForm: document.getElementById('register-form'),
                registerGamertag: document.getElementById('register-gamertag'),
                authFeedback: document.getElementById('auth-feedback'),
                authTitle: document.getElementById('auth-title'),
                toast: document.getElementById('toast'),
                verMaisBtn: document.querySelector('.ver-mais'),
                catalogModal: document.getElementById('catalog-section'),
                catalogList: document.getElementById('catalog-grid'),
                catalogEmpty: document.getElementById('catalog-empty'),
                catalogCloseBtn: document.getElementById('catalog-close-btn'),
                checkoutModal: document.getElementById('checkout-modal'),
                checkoutForm: document.getElementById('checkout-form'),
                checkoutClose: document.getElementById('checkout-close'),
                checkoutCancel: document.getElementById('checkout-cancel'),
                checkoutItems: document.getElementById('checkout-items'),
                checkoutTotal: document.getElementById('checkout-total'),
                checkoutFeedback: document.getElementById('checkout-feedback'),
                checkoutSubmit: document.getElementById('checkout-submit'),
                checkoutCardNumber: document.getElementById('checkout-card-number'),
                checkoutExpiry: document.getElementById('checkout-expiry'),
                checkoutCpf: document.getElementById('checkout-cpf'),
                checkoutCardName: document.getElementById('checkout-card-name'),
                checkoutCvv: document.getElementById('checkout-cvv')
            };

            function money(value) {
                const number = Number(value) || 0;
                return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function showToast(message) {
                if (!els.toast) return;
                const span = els.toast.querySelector('span');
                if (span) {
                    if (!els.toast.__defaultMessage) {
                        els.toast.__defaultMessage = span.textContent || '';
                    }
                    span.textContent = message || els.toast.__defaultMessage;
                }
                els.toast.classList.add('show');
                clearTimeout(window.__toastTimer);
                window.__toastTimer = setTimeout(() => {
                    els.toast.classList.remove('show');
                    if (span && message && els.toast.__defaultMessage) {
                        span.textContent = els.toast.__defaultMessage;
                    }
                }, 1600);
            }

            const loadCart = () => {
                try {
                    const raw = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
                    if (!Array.isArray(raw)) return [];
                    const unique = new Map();
                    raw.forEach(entry => {
                        if (!entry) return;
                        const key = entry.gameId ?? entry.id ?? entry.name;
                        if (!key) return;
                        if (!unique.has(key)) {
                            unique.set(key, {
                                ...entry,
                                qty: entry.qty && entry.qty > 0 ? entry.qty : 1,
                                id: entry.id || 'item-' + key,
                                gameId: typeof entry.gameId === 'number' ? entry.gameId : null,
                                price: Number(entry.price) || 0
                            });
                        }
                    });
                    return Array.from(unique.values());
                } catch (err) {
                    console.error('Falha ao carregar carrinho', err);
                    return [];
                }
            };

            const saveCart = (cart) => {
                localStorage.setItem(CART_KEY, JSON.stringify(cart));
            };

            function updateCartBadge(count) {
                if (!els.cartBadge) {
                    return;
                }
                const badge = els.cartBadge;
                const total = Number(count) || 0;
                if (total <= 0) {
                    badge.textContent = '0';
                    badge.classList.add('hidden');
                    return;
                }
                badge.textContent = total > 99 ? '99+' : String(total);
                badge.classList.remove('hidden');
            }

            function saveLibrarySnapshot(library) {
                if (!library) return;
                const games = Array.isArray(library) ? library : (library.games || []);
                try {
                    const payload = {
                        games: games.map(game => ({
                            id: game.id,
                            nome: game.nome,
                            preco: game.preco,
                            imagem: game.imagem
                        })),
                        updatedAt: Date.now()
                    };
                    localStorage.setItem(LIBRARY_KEY, JSON.stringify(payload));
                } catch (err) {
                    console.warn('Falha ao salvar biblioteca local', err);
                }
            }

            function clearLibrarySnapshot() {
                localStorage.removeItem(LIBRARY_KEY);
            }

            function openCart() {
                if (!els.cartDrawer || !els.cartOverlay) return;
                els.cartDrawer.classList.add('open');
                els.cartOverlay.classList.add('open');
                els.cartDrawer.setAttribute('aria-hidden', 'false');
            }

            function closeCart() {
                if (!els.cartDrawer || !els.cartOverlay) return;
                els.cartDrawer.classList.remove('open');
                els.cartOverlay.classList.remove('open');
                els.cartDrawer.setAttribute('aria-hidden', 'true');
            }

            function renderCart() {
                if (!els.cartItems) return;
                const cart = loadCart();
                els.cartItems.innerHTML = '';
                if (!cart.length) {
                    els.cartItems.innerHTML = '<div class="cart-empty">Seu carrinho esta vazio.</div>';
                    if (els.cartTotal) {
                        els.cartTotal.textContent = 'R$ 0,00';
                    }
                    updateCartBadge(0);
                    return;
                }
                let total = 0;
                let totalItems = 0;
                cart.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'cart-item';
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.name;
                    row.appendChild(img);
                    const info = document.createElement('div');
                    info.className = 'info';
                    const name = document.createElement('div');
                    name.className = 'name';
                    name.textContent = item.name;
                    info.appendChild(name);
                    const price = document.createElement('div');
                    price.className = 'price';
                    price.textContent = money(item.price) + (item.qty > 1 ? ' x' + item.qty : '');
                    info.appendChild(price);
                    row.appendChild(info);
                    const remove = document.createElement('div');
                    remove.className = 'remove';
                    remove.textContent = 'Remover';
                    remove.addEventListener('click', () => {
                        const current = loadCart();
                        current.splice(idx, 1);
                        saveCart(current);
                        renderCart();
                    });
                    row.appendChild(remove);
                    els.cartItems.appendChild(row);
                    total += item.price * (item.qty || 1);
                    totalItems += item.qty && item.qty > 0 ? item.qty : 1;
                });
                if (els.cartTotal) {
                    els.cartTotal.textContent = money(total);
                }
                updateCartBadge(totalItems);
            }

            function setCheckoutFeedback(message, tone = 'info') {
                if (!els.checkoutFeedback) return;
                els.checkoutFeedback.textContent = message || '';
                els.checkoutFeedback.classList.remove('error', 'success');
                if (!message) {
                    els.checkoutFeedback.classList.add('hidden');
                    return;
                }
                els.checkoutFeedback.classList.remove('hidden');
                if (tone === 'error') {
                    els.checkoutFeedback.classList.add('error');
                } else if (tone === 'success') {
                    els.checkoutFeedback.classList.add('success');
                }
            }

            function populateCheckoutItems(list) {
                if (!els.checkoutItems) {
                    return;
                }
                els.checkoutItems.innerHTML = '';
                const items = Array.isArray(list) ? list : [];
                if (!items.length) {
                    const empty = document.createElement('li');
                    empty.textContent = 'Carrinho vazio';
                    els.checkoutItems.appendChild(empty);
                    return;
                }
                items.forEach(entry => {
                    const li = document.createElement('li');
                    const name = document.createElement('span');
                    name.textContent = entry.name + (entry.qty > 1 ? ` x${entry.qty}` : '');
                    const total = document.createElement('strong');
                    total.textContent = money(entry.price * entry.qty);
                    li.appendChild(name);
                    li.appendChild(total);
                    els.checkoutItems.appendChild(li);
                });
            }

            function openCheckoutModal(session) {
                checkoutSession = session;
                if (els.checkoutForm) {
                    els.checkoutForm.reset();
                }
                setCheckoutFeedback('');
                if (els.checkoutTotal) {
                    els.checkoutTotal.textContent = money(session.total);
                }
                populateCheckoutItems(session.cartSnapshot);
                if (els.checkoutModal) {
                    els.checkoutModal.classList.add('open');
                    els.checkoutModal.setAttribute('aria-hidden', 'false');
                }
                document.body.style.overflow = 'hidden';
                if (els.checkoutSubmit) {
                    els.checkoutSubmit.disabled = false;
                }
                requestAnimationFrame(() => {
                    if (els.checkoutCardName) {
                        els.checkoutCardName.focus();
                    }
                });
            }

            function closeCheckoutModal() {
                const wasOpen = els.checkoutModal && els.checkoutModal.classList.contains('open');
                if (els.checkoutModal) {
                    els.checkoutModal.classList.remove('open');
                    els.checkoutModal.setAttribute('aria-hidden', 'true');
                }
                if (els.checkoutForm) {
                    els.checkoutForm.reset();
                }
                setCheckoutFeedback('');
                checkoutSession = null;
                if (wasOpen) {
                    document.body.style.overflow = '';
                }
            }

            function detectCardBrand(number) {
                if (!number) return 'DESCONHECIDA';
                if (/^4/.test(number)) return 'VISA';
                if (/^5[1-5]/.test(number)) return 'MASTERCARD';
                if (/^3[47]/.test(number)) return 'AMEX';
                if (/^3(?:0[0-5]|[68])/.test(number)) return 'DINERS';
                if (/^6(?:011|5)/.test(number)) return 'DISCOVER';
                if (/^(?:2131|1800|35)/.test(number)) return 'JCB';
                if (/^63/.test(number)) return 'HIPER';
                if (/^50/.test(number)) return 'AURA';
                return 'DESCONHECIDA';
            }

            async function buildCheckoutSession() {
                const cart = loadCart();
                if (!cart.length) {
                    alert('Carrinho vazio.');
                    return null;
                }
                if (!currentUser) {
                    closeCart();
                    openAuthModal('login', 'Faça login para finalizar sua compra.');
                    return null;
                }
                const items = cart
                    .map(item => ({
                        gameId: Number(item.gameId),
                        quantity: item.qty || 1
                    }))
                    .filter(item => Number.isInteger(item.gameId) && item.gameId > 0);
                if (!items.length) {
                    alert('Sincronizando itens com o catálogo. Tente novamente.');
                    await loadCatalog();
                    upgradeCartFromBackend();
                    return null;
                }
                const snapshot = cart.map(entry => ({
                    name: entry.name,
                    qty: entry.qty || 1,
                    price: Number(entry.price) || 0
                }));
                const total = snapshot.reduce((sum, entry) => sum + entry.price * entry.qty, 0);
                return {
                    items,
                    cartSnapshot: snapshot,
                    total
                };
            }

            function formatCardNumber(value) {
                const digits = value.replace(/\D/g, '').slice(0, 19);
                return digits.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
            }

            function formatExpiry(value) {
                const digits = value.replace(/\D/g, '').slice(0, 4);
                if (digits.length <= 2) {
                    return digits;
                }
                return digits.slice(0, 2) + '/' + digits.slice(2);
            }

            function formatCpf(value) {
                const digits = value.replace(/\D/g, '').slice(0, 11);
                const parts = [];
                if (digits.length > 0) parts.push(digits.slice(0, Math.min(3, digits.length)));
                if (digits.length > 3) parts.push(digits.slice(3, Math.min(6, digits.length)));
                if (digits.length > 6) parts.push(digits.slice(6, Math.min(9, digits.length)));
                const remainder = digits.length > 9 ? digits.slice(9) : '';
                let formatted = parts
                    .filter(Boolean)
                    .join('.');
                if (remainder) {
                    formatted += (formatted ? '-' : '') + remainder;
                }
                return formatted;
            }

            function renderCatalogModal() {
                if (!els.catalogList) return;
                const list = Array.isArray(backendGames) ? [...backendGames] : [];
                list.sort((a, b) => {
                    const nameA = (a && a.nome ? a.nome : '').toLowerCase();
                    const nameB = (b && b.nome ? b.nome : '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
                els.catalogList.innerHTML = '';
                if (!list.length) {
                    if (els.catalogEmpty) {
                        els.catalogEmpty.classList.remove('hidden');
                        els.catalogEmpty.textContent = 'Nenhum jogo cadastrado ainda.';
                    }
                    return;
                }
                if (els.catalogEmpty) {
                    els.catalogEmpty.classList.add('hidden');
                }
                const fragment = document.createDocumentFragment();
                list.forEach(game => {
                    const name = game && game.nome ? game.nome : 'Jogo';
                    const priceValue = Number(game && game.preco) || 0;
                    const imageUrl = game && game.imagem ? game.imagem : '';
                    const gameId = Number(game && game.id) || null;
                    const card = document.createElement('article');
                    card.className = 'catalog-card';
                    if (gameId) {
                        card.dataset.gameId = String(gameId);
                    }
                    card.dataset.gameName = name;
                    card.dataset.gamePrice = String(priceValue);
                    if (imageUrl) {
                        const cover = document.createElement('img');
                        cover.src = imageUrl;
                        cover.alt = `Capa de ${name}`;
                        cover.loading = 'lazy';
                        card.appendChild(cover);
                    }
                    const body = document.createElement('div');
                    body.className = 'catalog-card__body';
                    const title = document.createElement('h3');
                    title.className = 'catalog-card__title';
                    title.textContent = name;
                    body.appendChild(title);
                    const price = document.createElement('p');
                    price.className = 'catalog-card__price';
                    price.textContent = money(priceValue);
                    body.appendChild(price);
                    const actions = document.createElement('div');
                    actions.className = 'catalog-card__actions';
                    const addBtn = document.createElement('button');
                    addBtn.type = 'button';
                    addBtn.className = 'catalog-card__action catalog-card__add';
                    addBtn.textContent = 'Adicionar ao carrinho';
                    addBtn.addEventListener('click', (event) => {
                        event.preventDefault();
                        const base = typeof name.normalize === 'function'
                            ? name.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                            : name;
                        const slug = base.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'item';
                        const item = {
                            name,
                            price: priceValue,
                            image: imageUrl,
                            id: gameId ? `game-${gameId}` : `game-${slug}`,
                            gameId
                        };
                        addToCart(item);
                    });
                    actions.appendChild(addBtn);
                    if (isAdmin() && gameId) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.className = 'catalog-card__action catalog-card__delete';
                        deleteBtn.dataset.gameId = String(gameId);
                        deleteBtn.textContent = 'Excluir';
                        deleteBtn.addEventListener('click', (event) => {
                            event.preventDefault();
                            if (confirm('Remover este jogo do catalogo?')) {
                                deleteGame(gameId);
                            }
                        });
                        actions.appendChild(deleteBtn);
                    }
                    body.appendChild(actions);
                    card.appendChild(body);
                    fragment.appendChild(card);
                });
                els.catalogList.appendChild(fragment);
            }

            function openCatalogModal() {
                if (!els.catalogModal) return;
                renderCatalogModal();
                els.catalogModal.classList.remove('hidden');
                els.catalogModal.setAttribute('aria-hidden', 'false');
                requestAnimationFrame(() => {
                    els.catalogModal.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            }

            function closeCatalogModal() {
                if (!els.catalogModal) return;
                els.catalogModal.classList.add('hidden');
                els.catalogModal.setAttribute('aria-hidden', 'true');
                if (els.verMaisBtn) {
                    requestAnimationFrame(() => {
                        try {
                            els.verMaisBtn.focus({ preventScroll: true });
                        } catch (err) {
                            els.verMaisBtn.focus();
                        }
                    });
                }
            }

            async function deleteGame(gameId) {
                if (!gameId) {
                    return;
                }
                try {
                    await api(`/admin/games?id=${encodeURIComponent(gameId)}`, { method: 'DELETE' });
                    showToast('Jogo removido do catalogo.');
                    backendGames = backendGames.filter(game => game && game.id !== Number(gameId));
                    renderCatalogModal();
                    await loadCatalog();
                } catch (err) {
                    alert(err.message || 'Nao foi possivel remover o jogo.');
                }
            }

            function addToCart(item) {
                const cart = loadCart();
                const exists = cart.some(existing => {
                    if (item.gameId && existing.gameId) {
                        return existing.gameId === item.gameId;
                    }
                    if (item.id && existing.id) {
                        return existing.id === item.id;
                    }
                    return existing.name === item.name;
                });
                if (exists) {
                    showToast('Voce ja adicionou este item ao carrinho.');
                    return;
                }
                cart.push({ ...item, qty: 1 });
                saveCart(cart);
                renderCart();
                showToast('Adicionado com sucesso ao seu carrinho');
            }

            function findGameByName(name) {
                if (!name) return null;
                return gameIndex.get(name.trim().toLowerCase()) || null;
            }

            function syncCardWithBackend(card) {
                const meta = ensureCardMeta(card);
                if (meta.gameId) {
                    const priceEl = card.querySelector('.overlay-price');
                    if (priceEl) {
                        priceEl.textContent = money(meta.price);
                    }
                }
            }

            function upgradeCartFromBackend() {
                const cart = loadCart();
                let changed = false;
                cart.forEach(entry => {
                    const game = findGameByName(entry.name);
                    if (game) {
                        if (entry.gameId !== game.id) {
                            entry.gameId = game.id;
                            entry.id = 'game-' + game.id;
                            changed = true;
                        }
                        if (Math.abs((entry.price || 0) - Number(game.preco)) > 0.009) {
                            entry.price = Number(game.preco);
                            changed = true;
                        }
                    }
                });
                if (changed) {
                    saveCart(cart);
                    renderCart();
                }
            }

            function getNameFromImageSrc(src) {
                const file = (src || '').split('/').pop().split('\\').pop();
                const base = file.replace(/\.(png|jpe?g|webp)$/i, '');
                return base.replace(/[-_]/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
            }

            function ensureCardMeta(card) {
                if (!card) {
                    return { name: 'Jogo', price: 10, image: '', id: '', gameId: null };
                }
                const img = card.querySelector('img');
                const src = img ? img.getAttribute('src') || '' : '';
                let name = (card.dataset.productName || '').trim();
                if (!name) {
                    const overlayTitle = card.querySelector('.overlay-title');
                    if (overlayTitle && overlayTitle.textContent) {
                        name = overlayTitle.textContent.trim();
                    }
                }
                if (!name) {
                    name = getNameFromImageSrc(src);
                }
                if (name) {
                    card.dataset.productName = name;
                }

                let price = Number(card.dataset.productPrice);
                if (!Number.isFinite(price)) {
                    const overlayPrice = card.querySelector('.overlay-price');
                    if (overlayPrice && overlayPrice.textContent) {
                        const raw = overlayPrice.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
                        const parsed = Number(raw);
                        if (Number.isFinite(parsed)) {
                            price = parsed;
                        }
                    }
                }
                if (!Number.isFinite(price)) {
                    price = 10;
                }

                const game = findGameByName(name);
                let backendId = Number(card.dataset.backendId);
                if (game) {
                    backendId = Number(game.id);
                    price = Number(game.preco);
                }
                if (!Number.isFinite(backendId)) {
                    backendId = null;
                }

                let id = card.dataset.productId;
                if (backendId) {
                    id = 'game-' + backendId;
                }
                if (!id) {
                    const base = name || src || card.id || '';
                    id = base ? base.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') : '';
                    if (!id) {
                        id = 'card-' + Math.random().toString(36).slice(2, 10);
                    }
                }

                card.dataset.productId = id;
                card.dataset.productPrice = String(price);
                if (backendId) {
                    card.dataset.backendId = String(backendId);
                } else {
                    delete card.dataset.backendId;
                }
                if (img && name && !img.getAttribute('alt')) {
                    img.setAttribute('alt', name);
                }

                return { name, price, image: src, id, gameId: backendId };
            }

            function decorateCard(card) {
                if (!card || card.querySelector('.card-overlay')) return;
                if (card.classList.contains('grande') && card.closest('.novidades')) return;
                const meta = ensureCardMeta(card);
                const overlay = document.createElement('div');
                overlay.className = 'card-overlay';
                const titleEl = document.createElement('div');
                titleEl.className = 'overlay-title';
                titleEl.textContent = meta.name;
                const priceEl = document.createElement('div');
                priceEl.className = 'overlay-price';
                priceEl.textContent = money(meta.price);
                const btn = document.createElement('button');
                btn.className = 'btn-add btn-autogen';
                btn.type = 'button';
                btn.setAttribute('aria-label', 'Adicionar ao carrinho');
                btn.textContent = '+';
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const refreshed = ensureCardMeta(card);
                    addToCart(refreshed);
                });
                btn.__bound = true;
                overlay.appendChild(titleEl);
                overlay.appendChild(priceEl);
                overlay.appendChild(btn);
                card.appendChild(overlay);
            }

            function decorateCards() {
                const cards = Array.from(document.querySelectorAll('.card'));
                cards.forEach((card, idx) => {
                    if (!card.dataset.productId) {
                        card.dataset.productId = 'card-' + idx;
                    }
                    ensureCardMeta(card);
                    if (!card.querySelector('.card-overlay')) {
                        decorateCard(card);
                    }
                });
                document.querySelectorAll('.card .btn-add').forEach(btn => {
                    if (btn.__bound) return;
                    btn.__bound = true;
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const card = btn.closest('.card');
                        const meta = ensureCardMeta(card);
                        addToCart(meta);
                    });
                });
            }

            function setToken(token) {
                if (token) {
                    localStorage.setItem(TOKEN_KEY, token);
                }
            }

            function getToken() {
                return localStorage.getItem(TOKEN_KEY);
            }

            function clearToken() {
                localStorage.removeItem(TOKEN_KEY);
            }

            function isAdmin() {
                return currentUser && (currentUser.role || '').toUpperCase() === 'ADMIN';
            }

            async function api(path, options = {}) {
                const opts = { ...options };
                opts.headers = { ...(options.headers || {}) };
                if (opts.body && !opts.headers['Content-Type']) {
                    opts.headers['Content-Type'] = 'application/json';
                }
                const token = getToken();
                if (token) {
                    opts.headers['Authorization'] = 'Bearer ' + token;
                }
                const response = await fetch(API_BASE + path, opts);
                const text = await response.text();
                let data = null;
                if (text) {
                    try {
                        data = JSON.parse(text);
                    } catch (err) {
                        console.warn('Resposta nao e JSON valido', err);
                    }
                }
                if (!response.ok) {
                    const message = data && data.error ? data.error : 'Erro ' + response.status;
                    throw new Error(message);
                }
                return data;
            }

            async function syncLibrary() {
                if (!getToken()) {
                    clearLibrarySnapshot();
                    return;
                }
                try {
                    const data = await api('/users/library', { method: 'GET' });
                    const games = Array.isArray(data)
                        ? data
                        : (data && Array.isArray(data.games) ? data.games : []);
                    if (games.length) {
                        saveLibrarySnapshot(games);
                    }
                } catch (err) {
                    console.warn('Falha ao sincronizar biblioteca', err);
                }
            }

            function updateAuthUI() {
                if (!els.navUser || !els.navUserGamertag) return;
                const displayName = currentUser ? (currentUser.gamertag || currentUser.email) : '';
                const logged = Boolean(displayName);
                els.navUser.classList.toggle('hidden', !logged);
                els.navUserGamertag.textContent = logged ? displayName : '';
                if (els.loginBtn) {
                    els.loginBtn.style.display = logged ? 'none' : '';
                }
                if (els.profileLink) {
                    els.profileLink.style.display = logged ? '' : 'none';
                    if (!logged) {
                        els.profileLink.classList.remove('active');
                    }
                }
                renderCatalogModal();
            }

            async function refreshUser() {
                const token = getToken();
                if (!token) {
                    currentUser = null;
                    updateAuthUI();
                    return;
                }
                try {
                    const data = await api('/auth/me', { method: 'GET' });
                    currentUser = data;
                    await syncLibrary();
                } catch (err) {
                    console.warn('Sessão invalida', err);
                    clearToken();
                    clearLibrarySnapshot();
                    currentUser = null;
                }
                updateAuthUI();
            }

            function setAuthFeedback(message, success = false) {
                if (!els.authFeedback) return;
                els.authFeedback.textContent = message || '';
                els.authFeedback.classList.toggle('success', success);
            }
            function isValidGamertag(value) {
                return Boolean(value) && GAMERTAG_REGEX.test(value.trim());
            }

            function switchAuthTab(mode) {
                if (!mode || !els.loginForm || !els.registerForm) return;
                els.authTabs.forEach(tab => {
                    const active = tab.dataset.authTab === mode;
                    tab.classList.toggle('active', active);
                });
                els.loginForm.classList.toggle('hidden', mode !== 'login');
                els.registerForm.classList.toggle('hidden', mode !== 'register');
                if (els.authTitle) {
                    els.authTitle.textContent = mode === 'register' ? 'Criar conta' : 'Entrar';
                }
                setAuthFeedback('');
            }

            function openAuthModal(mode = 'login', message = '') {
                if (!els.authOverlay) return;
                switchAuthTab(mode);
                els.authOverlay.classList.remove('hidden');
                els.authOverlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                if (message) {
                    setAuthFeedback(message, false);
                }
            }

            function closeAuthModal() {
                if (!els.authOverlay) return;
                els.authOverlay.classList.add('hidden');
                els.authOverlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                setAuthFeedback('');
            }

            async function handleCheckout() {
                const session = await buildCheckoutSession();
                if (!session) {
                    return;
                }
                closeCart();
                openCheckoutModal(session);
            }

            async function submitCheckout(event) {
                event.preventDefault();
                if (!checkoutSession || !checkoutSession.items || !checkoutSession.items.length) {
                    setCheckoutFeedback('Não encontramos seu carrinho. Abra o carrinho e tente novamente.', 'error');
                    return;
                }
                const form = event.currentTarget;
                const name = (form.cardName.value || '').trim();
                const rawNumber = form.cardNumber.value || '';
                const sanitizedNumber = rawNumber.replace(/\D/g, '').slice(0, 19);
                const expiry = (form.cardExpiry.value || '').trim();
                const cvv = (form.cardCvv.value || '').trim();
                const cpf = (form.cardCpf.value || '').replace(/\D/g, '').trim();

                if (name.length < 3) {
                    setCheckoutFeedback('Informe o nome completo do titular.', 'error');
                    form.cardName.focus();
                    return;
                }
                if (!/^\d{13,19}$/.test(sanitizedNumber)) {
                    setCheckoutFeedback('Número do cartão inválido.', 'error');
                    form.cardNumber.focus();
                    return;
                }
                if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) {
                    setCheckoutFeedback('Informe a validade no formato MM/AA.', 'error');
                    form.cardExpiry.focus();
                    return;
                }
                const [expMonthStr, expYearStr] = expiry.split('/');
                const expMonth = Number(expMonthStr);
                const expYear = Number('20' + expYearStr);
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                    setCheckoutFeedback('Este cartão está expirado.', 'error');
                    form.cardExpiry.focus();
                    return;
                }
                if (!/^\d{3,4}$/.test(cvv)) {
                    setCheckoutFeedback('CVV inválido.', 'error');
                    form.cardCvv.focus();
                    return;
                }
                if (cpf && cpf.length !== 11) {
                    setCheckoutFeedback('CPF informado parece incorreto.', 'error');
                    form.cardCpf.focus();
                    return;
                }

                const totalFormatted = checkoutSession ? money(checkoutSession.total) : null;
                setCheckoutFeedback('Processando o pagamento...', 'info');
                if (els.checkoutSubmit) {
                    els.checkoutSubmit.disabled = true;
                }

                try {
                    const payment = {
                        holder: name,
                        last4: sanitizedNumber.slice(-4),
                        brand: detectCardBrand(sanitizedNumber),
                        expiry
                    };
                    const result = await api('/cart/checkout', {
                        method: 'POST',
                        body: JSON.stringify({
                            items: checkoutSession.items,
                            payment
                        })
                    });
                    if (result && result.library) {
                        saveLibrarySnapshot(result.library);
                    }
                    saveCart([]);
                    renderCart();
                    closeCheckoutModal();
                    const successMessage = totalFormatted ? 'Pagamento aprovado! Total de ' + totalFormatted + '.' : 'Pagamento aprovado!';
                    showToast(successMessage);
                    closeCart();
                } catch (err) {
                    console.error(err);
                    setCheckoutFeedback(err.message || 'Não foi possível concluir o pagamento.', 'error');
                } finally {
                    if (els.checkoutSubmit) {
                        els.checkoutSubmit.disabled = false;
                    }
                }
            }
            async function loadCatalog() {
                try {
                    const response = await fetch(API_BASE + '/games');
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        backendGames = data;
                        gameIndex.clear();
                        backendGames.forEach(game => {
                            if (game && game.nome) {
                                gameIndex.set(game.nome.trim().toLowerCase(), game);
                            }
                        });
                        document.querySelectorAll('.card').forEach(syncCardWithBackend);
                        upgradeCartFromBackend();
                        renderCatalogModal();
                    }
                } catch (err) {
                    console.warn('Falha ao carregar catalogo do backend', err);
                }
            }

            if (els.navCart) {
                els.navCart.addEventListener('click', (e) => {
                    e.preventDefault();
                    openCart();
                });
            }
            if (els.cartOverlay) {
                els.cartOverlay.addEventListener('click', (e) => {
                    if (e.target === els.cartOverlay) {
                        closeCart();
                    }
                });
            }
            if (els.cartClose) {
                els.cartClose.addEventListener('click', closeCart);
            }
            if (els.cartClear) {
                els.cartClear.addEventListener('click', () => {
                    saveCart([]);
                    renderCart();
                });
            }
            if (els.cartCheckout) {
                els.cartCheckout.addEventListener('click', handleCheckout);
            }

            if (els.checkoutClose) {
                els.checkoutClose.addEventListener('click', closeCheckoutModal);
            }
            if (els.checkoutCancel) {
                els.checkoutCancel.addEventListener('click', (event) => {
                    event.preventDefault();
                    closeCheckoutModal();
                });
            }
            if (els.checkoutModal) {
                els.checkoutModal.addEventListener('click', (event) => {
                    if (event.target === els.checkoutModal) {
                        closeCheckoutModal();
                    }
                });
            }
            if (els.checkoutForm) {
                els.checkoutForm.addEventListener('submit', submitCheckout);
            }
            if (els.checkoutCardNumber) {
                els.checkoutCardNumber.addEventListener('input', (event) => {
                    event.target.value = formatCardNumber(event.target.value);
                });
            }
            if (els.checkoutExpiry) {
                els.checkoutExpiry.addEventListener('input', (event) => {
                    event.target.value = formatExpiry(event.target.value);
                });
            }
            if (els.checkoutCpf) {
                els.checkoutCpf.addEventListener('input', (event) => {
                    event.target.value = formatCpf(event.target.value);
                });
            }
            if (els.checkoutCvv) {
                els.checkoutCvv.addEventListener('input', (event) => {
                    event.target.value = event.target.value.replace(/\D/g, '').slice(0, 4);
                });
            }

            if (els.verMaisBtn) {
                els.verMaisBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    openCatalogModal();
                });
            }
            if (els.catalogCloseBtn) {
                els.catalogCloseBtn.addEventListener('click', (event) => {
                    event.preventDefault();
                    closeCatalogModal();
                });
            }

            if (els.loginBtn) {
                els.loginBtn.addEventListener('click', () => openAuthModal('login'));
            }
            if (els.logoutBtn) {
                els.logoutBtn.addEventListener('click', async () => {
                    try {
                        await api('/auth/logout', { method: 'POST' });
                    } catch (err) {
                        console.warn('Falha ao encerrar sessão', err);
                    }
                    clearToken();
                    currentUser = null;
                    updateAuthUI();
                    closeCatalogModal();
                    closeCheckoutModal();
                    showToast('Voce saiu da conta.');
                });
            }
            if (els.authClose) {
                els.authClose.addEventListener('click', closeAuthModal);
            }
            if (els.authOverlay) {
                els.authOverlay.addEventListener('click', (e) => {
                    if (e.target === els.authOverlay) {
                        closeAuthModal();
                    }
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key !== 'Escape') {
                    return;
                }
                if (els.authOverlay && !els.authOverlay.classList.contains('hidden')) {
                    closeAuthModal();
                }
                if (els.catalogModal && !els.catalogModal.classList.contains('hidden')) {
                    closeCatalogModal();
                }
                if (els.checkoutModal && els.checkoutModal.classList.contains('open')) {
                    closeCheckoutModal();
                }
            });

            els.authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.dataset.authTab;
                    switchAuthTab(mode);
                });
            });

            if (els.loginForm) {
                els.loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const form = event.currentTarget;
                    const email = form.email.value.trim();
                    const password = form.password.value;
                    if (!email || !password) {
                        setAuthFeedback('Preencha e-mail e senha.');
                        return;
                    }
                    const submitBtn = form.querySelector('.auth-submit');
                    try {
                        submitBtn.disabled = true;
                        setAuthFeedback('Entrando...');
                        const data = await api('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({ email, password })
                        });
                        setToken(data.token);
                        await syncLibrary();
                        currentUser = {
                            id: data.id,
                            email: data.email,
                            gamertag: data.gamertag,
                            role: data.role,
                            plan: data.plan
                        };
                        updateAuthUI();
                        setAuthFeedback('Login realizado com sucesso!', true);
                        form.reset();
                        setTimeout(() => {
                            closeAuthModal();
                        }, 700);
                    } catch (err) {
                        setAuthFeedback(err.message || 'Não foi possível entrar.');
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }

            if (els.registerForm) {
                els.registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const form = event.currentTarget;
                    const email = form.email.value.trim();
                    const gamertagInput = form.gamertag || form.querySelector('#register-gamertag');
                    const gamertag = gamertagInput ? gamertagInput.value.trim() : '';
                    const password = form.password.value;
                    if (!email || !password) {
                        setAuthFeedback('Preencha e-mail, gamertag e senha.');
                        return;
                    }
                    if (!isValidGamertag(gamertag)) {
                        setAuthFeedback('Gamertag invalida. Use entre 3 e 20 caracteres contendo letras, numeros, ".", "-" ou "_".');
                        return;
                    }
                    const submitBtn = form.querySelector('.auth-submit');
                    try {
                        submitBtn.disabled = true;
                        setAuthFeedback('Criando conta...');
                        await api('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify({ email, password, gamertag })
                        });
                        form.reset();
                        setAuthFeedback('Conta criada! Faça login para continuar.', true);
                        switchAuthTab('login');
                    } catch (err) {
                        setAuthFeedback(err.message || 'Não foi possível criar a conta.');
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }

            decorateCards();
            renderCart();
            refreshUser();
            loadCatalog();
        });
    </script>
    </body>
</html>



