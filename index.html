<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strum - Loja</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <header>
        <div class="header-top">
            <div class="logo">
                <img src="css/Strum Logo Sem Fundo.png" alt="Logo Strum">
            </div>
        </div>

        <nav class="header-bottom">
            <div class="nav-links">
                <a href="#">LOJA</a>
                <a href="#">COMUNIDADE</a>
                <a href="sobre.html">SOBRE</a>
                <a href="#">SUPORTE</a>
            </div>
            <div class="nav-actions">
                <button type="button" class="nav-action icon-cart" aria-label="Abrir carrinho">Carrinho</button>
                <button type="button" class="nav-action icon-login" id="btn-login" aria-haspopup="dialog">Login</button>
                <div class="nav-user hidden" id="nav-user" aria-live="polite">
                    <span id="nav-user-email"></span>
                    <button type="button" class="nav-action nav-logout" id="btn-logout">Sair</button>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="banner"><img src="css/Imagens/PROMOÇÃO DE FÉRIAS 01122025 - 01022026.png"></div>

        <section class="destaques">
            <h2>DESTAQUES <span class="ver-mais">VER MAIS</span></h2>
            <div class="grid">
                <div class="card grande d1">
                    <img src="css/Imagens/grand-theft-auto-6.png" alt="Grand Theft Auto 6">
                    <div class="card-overlay">
                        <div class="overlay-title">Grand Theft Auto 6</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d2">
                    <img src="css/Imagens/metal-gear-solid-v-the-phantom-pain.jpg" alt="Metal Gear Solid V: The Phantom Pain">
                    <div class="card-overlay">
                        <div class="overlay-title">Metal Gear Solid V: The Phantom Pain</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d3">
                    <img src="css/Imagens/alan-wake-2.jpeg" alt="Alan Wake 2">
                    <div class="card-overlay">
                        <div class="overlay-title">Alan Wake 2</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d4">
                    <img src="css/Imagens/assassins-creed-mirage.png" alt="Assassin's Creed Mirage">
                    <div class="card-overlay">
                        <div class="overlay-title">Assassin's Creed Mirage</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
                <div class="card d5">
                    <img src="css/Imagens/dark-souls-remastered.png" alt="Dark Souls Remastered">
                    <div class="card-overlay">
                        <div class="overlay-title">Dark Souls Remastered</div>
                        <div class="overlay-price">R$ 10,00</div>
                        <button class="btn-add" type="button" aria-label="Adicionar ao carrinho">+</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="jogados">
            <h2>MAIS JOGADOS NO MOMENTO</h2>
            <div class="cards">
                <div class="card"><img src="css/Imagens/cyberpunk-2077.jpg"></div>
                <div class="card"><img src="css/Imagens/dying-light-2-stay-human.jpeg"></div>
                <div class="card"><img src="css/Imagens/detroit-become-human.jpg"></div>
                <div class="card"><img src="css/Imagens/god-of-war.jpeg"></div>
            </div>
        </section>

        <section class="lancamentos">
            <h2>LANAÇAMENTOS</h2>
            <div class="cards">
                <div class="card"><img src="css/Imagens/elden-ring.png"></div>
                <div class="card"><img src="css/Imagens/hogwarts-legacy.png"></div>
                <div class="card"><img src="css/Imagens/hades.jpg"></div>
                <div class="card"><img src="css/Imagens/grand-theft-auto-san-andreas.jpg"></div>
            </div>
        </section>

        <section class="novidades">
            <h2>NOVIDADES</h2>
            <div class="card grande"><img src="css/Imagens/Os jogos mais aguardados de 2026!.png"></div>
            <div class="cards">
                <div class="card"><img src="css/Imagens/hollow-knight.jpg"></div>
                <div class="card"><img src="css/Imagens/resident-evil-4.png"></div>
                <div class="card"><img src="css/Imagens/red-dead-redemption-2.jpg"></div>
                <div class="card"><img src="css/Imagens/the-last-of-us-part-1.png"></div>
            </div>
        </section>

    </main>

    <div class="auth-overlay hidden" id="auth-overlay" aria-hidden="true">
        <div class="auth-dialog" role="dialog" aria-labelledby="auth-title">
            <button type="button" class="auth-close" id="auth-close" aria-label="Fechar janela de login">&times;</button>
            <h3 id="auth-title">Entrar</h3>
            <div class="auth-tabs">
                <button type="button" class="auth-tab active" data-auth-tab="login">Entrar</button>
                <button type="button" class="auth-tab" data-auth-tab="register">Criar conta</button>
            </div>
            <form class="auth-form" id="login-form">
                <label for="login-email">E-mail</label>
                <input type="email" id="login-email" name="email" placeholder="email@exemplo.com" required>
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" name="password" placeholder="Sua senha" required>
                <button type="submit" class="auth-submit">Entrar</button>
            </form>
            <form class="auth-form hidden" id="register-form">
                <label for="register-email">E-mail</label>
                <input type="email" id="register-email" name="email" placeholder="email@exemplo.com" required>
                <label for="register-password">Senha</label>
                <input type="password" id="register-password" name="password" placeholder="Crie uma senha" minlength="4" required>
                <button type="submit" class="auth-submit">Criar conta</button>
            </form>
            <div class="auth-feedback" id="auth-feedback" role="status" aria-live="assertive"></div>
        </div>
    </div>
    <div class="toast" id="toast">
        <img src="css/Strum Logo Sem Fundo.png" alt="Strum">
        <span>Adicionado com sucesso ao seu carrinho</span>
    </div>

    <div class="cart-overlay" id="cart-overlay"></div>
    <aside class="cart-drawer" id="cart-drawer" aria-hidden="true" aria-label="Carrinho">
        <div class="cart-header">
            <h3>Seu Carrinho</h3>
            <span class="cart-close" id="cart-close">🛒•</span>
        </div>
        <div class="cart-items" id="cart-items">
            <div class="cart-empty">Seu carrinho esta vazio.</div>
        </div>
        <div class="cart-footer">
            <div class="cart-total"><span>Total</span><strong id="cart-total">R$ 0,00</strong></div>
            <div class="cart-actions">
                <button class="btn" id="cart-clear">Esvaziar</button>
                <button class="btn btn-primary" id="cart-checkout">Pagar</button>
            </div>
        </div>
    </aside>

    <footer>
        © 2025 Strum LTDA. Todos os direitos reservados.
    </footer>

        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = 'http://localhost:8000';
            const CART_KEY = 'cart';
            const TOKEN_KEY = 'strum_token';

            let backendGames = [];
            const gameIndex = new Map();
            let currentUser = null;

            const els = {
                cartDrawer: document.getElementById('cart-drawer'),
                cartOverlay: document.getElementById('cart-overlay'),
                cartClose: document.getElementById('cart-close'),
                cartItems: document.getElementById('cart-items'),
                cartTotal: document.getElementById('cart-total'),
                cartClear: document.getElementById('cart-clear'),
                cartCheckout: document.getElementById('cart-checkout'),
                navCart: document.querySelector('.icon-cart'),
                loginBtn: document.getElementById('btn-login'),
                logoutBtn: document.getElementById('btn-logout'),
                navUser: document.getElementById('nav-user'),
                navUserEmail: document.getElementById('nav-user-email'),
                authOverlay: document.getElementById('auth-overlay'),
                authClose: document.getElementById('auth-close'),
                authTabs: document.querySelectorAll('.auth-tab'),
                loginForm: document.getElementById('login-form'),
                registerForm: document.getElementById('register-form'),
                authFeedback: document.getElementById('auth-feedback'),
                authTitle: document.getElementById('auth-title'),
                toast: document.getElementById('toast')
            };

            function money(value) {
                const number = Number(value) || 0;
                return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function showToast(message) {
                if (!els.toast) return;
                const span = els.toast.querySelector('span');
                if (span) {
                    if (!els.toast.__defaultMessage) {
                        els.toast.__defaultMessage = span.textContent || '';
                    }
                    span.textContent = message || els.toast.__defaultMessage;
                }
                els.toast.classList.add('show');
                clearTimeout(window.__toastTimer);
                window.__toastTimer = setTimeout(() => {
                    els.toast.classList.remove('show');
                    if (span && message && els.toast.__defaultMessage) {
                        span.textContent = els.toast.__defaultMessage;
                    }
                }, 1600);
            }

            const loadCart = () => {
                try {
                    const raw = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
                    if (!Array.isArray(raw)) return [];
                    const unique = new Map();
                    raw.forEach(entry => {
                        if (!entry) return;
                        const key = entry.gameId ?? entry.id ?? entry.name;
                        if (!key) return;
                        if (!unique.has(key)) {
                            unique.set(key, {
                                ...entry,
                                qty: entry.qty && entry.qty > 0 ? entry.qty : 1,
                                id: entry.id || 'item-' + key,
                                gameId: typeof entry.gameId === 'number' ? entry.gameId : null,
                                price: Number(entry.price) || 0
                            });
                        }
                    });
                    return Array.from(unique.values());
                } catch (err) {
                    console.error('Falha ao carregar carrinho', err);
                    return [];
                }
            };

            const saveCart = (cart) => {
                localStorage.setItem(CART_KEY, JSON.stringify(cart));
            };

            function openCart() {
                if (!els.cartDrawer || !els.cartOverlay) return;
                els.cartDrawer.classList.add('open');
                els.cartOverlay.classList.add('open');
                els.cartDrawer.setAttribute('aria-hidden', 'false');
            }

            function closeCart() {
                if (!els.cartDrawer || !els.cartOverlay) return;
                els.cartDrawer.classList.remove('open');
                els.cartOverlay.classList.remove('open');
                els.cartDrawer.setAttribute('aria-hidden', 'true');
            }

            function renderCart() {
                if (!els.cartItems) return;
                const cart = loadCart();
                els.cartItems.innerHTML = '';
                if (!cart.length) {
                    els.cartItems.innerHTML = '<div class="cart-empty">Seu carrinho esta vazio.</div>';
                    if (els.cartTotal) {
                        els.cartTotal.textContent = 'R$ 0,00';
                    }
                    return;
                }
                let total = 0;
                cart.forEach((item, idx) => {
                    const row = document.createElement('div');
                    row.className = 'cart-item';
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.name;
                    row.appendChild(img);
                    const info = document.createElement('div');
                    info.className = 'info';
                    const name = document.createElement('div');
                    name.className = 'name';
                    name.textContent = item.name;
                    info.appendChild(name);
                    const price = document.createElement('div');
                    price.className = 'price';
                    price.textContent = money(item.price) + (item.qty > 1 ? ' x' + item.qty : '');
                    info.appendChild(price);
                    row.appendChild(info);
                    const remove = document.createElement('div');
                    remove.className = 'remove';
                    remove.textContent = 'Remover';
                    remove.addEventListener('click', () => {
                        const current = loadCart();
                        current.splice(idx, 1);
                        saveCart(current);
                        renderCart();
                    });
                    row.appendChild(remove);
                    els.cartItems.appendChild(row);
                    total += item.price * (item.qty || 1);
                });
                if (els.cartTotal) {
                    els.cartTotal.textContent = money(total);
                }
            }

            function addToCart(item) {
                const cart = loadCart();
                const exists = cart.some(existing => {
                    if (item.gameId && existing.gameId) {
                        return existing.gameId === item.gameId;
                    }
                    if (item.id && existing.id) {
                        return existing.id === item.id;
                    }
                    return existing.name === item.name;
                });
                if (exists) {
                    showToast('Voce ja adicionou este item ao carrinho.');
                    return;
                }
                cart.push({ ...item, qty: 1 });
                saveCart(cart);
                renderCart();
                showToast('Adicionado com sucesso ao seu carrinho');
            }

            function findGameByName(name) {
                if (!name) return null;
                return gameIndex.get(name.trim().toLowerCase()) || null;
            }

            function syncCardWithBackend(card) {
                const meta = ensureCardMeta(card);
                if (meta.gameId) {
                    const priceEl = card.querySelector('.overlay-price');
                    if (priceEl) {
                        priceEl.textContent = money(meta.price);
                    }
                }
            }

            function upgradeCartFromBackend() {
                const cart = loadCart();
                let changed = false;
                cart.forEach(entry => {
                    const game = findGameByName(entry.name);
                    if (game) {
                        if (entry.gameId !== game.id) {
                            entry.gameId = game.id;
                            entry.id = 'game-' + game.id;
                            changed = true;
                        }
                        if (Math.abs((entry.price || 0) - Number(game.preco)) > 0.009) {
                            entry.price = Number(game.preco);
                            changed = true;
                        }
                    }
                });
                if (changed) {
                    saveCart(cart);
                    renderCart();
                }
            }

            function getNameFromImageSrc(src) {
                const file = (src || '').split('/').pop().split('\\').pop();
                const base = file.replace(/\.(png|jpe?g|webp)$/i, '');
                return base.replace(/[-_]/g, ' ').replace(/\b\w/g, m => m.toUpperCase());
            }

            function ensureCardMeta(card) {
                if (!card) {
                    return { name: 'Jogo', price: 10, image: '', id: '', gameId: null };
                }
                const img = card.querySelector('img');
                const src = img ? img.getAttribute('src') || '' : '';
                let name = (card.dataset.productName || '').trim();
                if (!name) {
                    const overlayTitle = card.querySelector('.overlay-title');
                    if (overlayTitle && overlayTitle.textContent) {
                        name = overlayTitle.textContent.trim();
                    }
                }
                if (!name) {
                    name = getNameFromImageSrc(src);
                }
                if (name) {
                    card.dataset.productName = name;
                }

                let price = Number(card.dataset.productPrice);
                if (!Number.isFinite(price)) {
                    const overlayPrice = card.querySelector('.overlay-price');
                    if (overlayPrice && overlayPrice.textContent) {
                        const raw = overlayPrice.textContent.replace(/[^\d,.-]/g, '').replace(',', '.');
                        const parsed = Number(raw);
                        if (Number.isFinite(parsed)) {
                            price = parsed;
                        }
                    }
                }
                if (!Number.isFinite(price)) {
                    price = 10;
                }

                const game = findGameByName(name);
                let backendId = Number(card.dataset.backendId);
                if (game) {
                    backendId = Number(game.id);
                    price = Number(game.preco);
                }
                if (!Number.isFinite(backendId)) {
                    backendId = null;
                }

                let id = card.dataset.productId;
                if (backendId) {
                    id = 'game-' + backendId;
                }
                if (!id) {
                    const base = name || src || card.id || '';
                    id = base ? base.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') : '';
                    if (!id) {
                        id = 'card-' + Math.random().toString(36).slice(2, 10);
                    }
                }

                card.dataset.productId = id;
                card.dataset.productPrice = String(price);
                if (backendId) {
                    card.dataset.backendId = String(backendId);
                } else {
                    delete card.dataset.backendId;
                }
                if (img && name && !img.getAttribute('alt')) {
                    img.setAttribute('alt', name);
                }

                return { name, price, image: src, id, gameId: backendId };
            }

            function decorateCard(card) {
                if (!card || card.querySelector('.card-overlay')) return;
                if (card.classList.contains('grande') && card.closest('.novidades')) return;
                const meta = ensureCardMeta(card);
                const overlay = document.createElement('div');
                overlay.className = 'card-overlay';
                const titleEl = document.createElement('div');
                titleEl.className = 'overlay-title';
                titleEl.textContent = meta.name;
                const priceEl = document.createElement('div');
                priceEl.className = 'overlay-price';
                priceEl.textContent = money(meta.price);
                const btn = document.createElement('button');
                btn.className = 'btn-add btn-autogen';
                btn.type = 'button';
                btn.setAttribute('aria-label', 'Adicionar ao carrinho');
                btn.textContent = '+';
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const refreshed = ensureCardMeta(card);
                    addToCart(refreshed);
                });
                btn.__bound = true;
                overlay.appendChild(titleEl);
                overlay.appendChild(priceEl);
                overlay.appendChild(btn);
                card.appendChild(overlay);
            }

            function decorateCards() {
                const cards = Array.from(document.querySelectorAll('.card'));
                cards.forEach((card, idx) => {
                    if (!card.dataset.productId) {
                        card.dataset.productId = 'card-' + idx;
                    }
                    ensureCardMeta(card);
                    if (!card.querySelector('.card-overlay')) {
                        decorateCard(card);
                    }
                });
                document.querySelectorAll('.card .btn-add').forEach(btn => {
                    if (btn.__bound) return;
                    btn.__bound = true;
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const card = btn.closest('.card');
                        const meta = ensureCardMeta(card);
                        addToCart(meta);
                    });
                });
            }

            function setToken(token) {
                if (token) {
                    localStorage.setItem(TOKEN_KEY, token);
                }
            }

            function getToken() {
                return localStorage.getItem(TOKEN_KEY);
            }

            function clearToken() {
                localStorage.removeItem(TOKEN_KEY);
            }

            async function api(path, options = {}) {
                const opts = { ...options };
                opts.headers = { ...(options.headers || {}) };
                if (opts.body && !opts.headers['Content-Type']) {
                    opts.headers['Content-Type'] = 'application/json';
                }
                const token = getToken();
                if (token) {
                    opts.headers['Authorization'] = 'Bearer ' + token;
                }
                const response = await fetch(API_BASE + path, opts);
                const text = await response.text();
                let data = null;
                if (text) {
                    try {
                        data = JSON.parse(text);
                    } catch (err) {
                        console.warn('Resposta nao e JSON valido', err);
                    }
                }
                if (!response.ok) {
                    const message = data && data.error ? data.error : 'Erro ' + response.status;
                    throw new Error(message);
                }
                return data;
            }

            function updateAuthUI() {
                if (!els.loginBtn || !els.navUser || !els.navUserEmail) return;
                if (currentUser && currentUser.email) {
                    els.navUser.classList.remove('hidden');
                    els.navUserEmail.textContent = currentUser.email;
                    els.loginBtn.style.display = 'none';
                } else {
                    els.navUser.classList.add('hidden');
                    els.navUserEmail.textContent = '';
                    els.loginBtn.style.display = '';
                }
            }

            async function refreshUser() {
                const token = getToken();
                if (!token) {
                    currentUser = null;
                    updateAuthUI();
                    return;
                }
                try {
                    const data = await api('/auth/me', { method: 'GET' });
                    currentUser = data;
                } catch (err) {
                    console.warn('Sessão invalida', err);
                    clearToken();
                    currentUser = null;
                }
                updateAuthUI();
            }

            function setAuthFeedback(message, success = false) {
                if (!els.authFeedback) return;
                els.authFeedback.textContent = message || '';
                els.authFeedback.classList.toggle('success', success);
            }

            function switchAuthTab(mode) {
                if (!mode || !els.loginForm || !els.registerForm) return;
                els.authTabs.forEach(tab => {
                    const active = tab.dataset.authTab === mode;
                    tab.classList.toggle('active', active);
                });
                els.loginForm.classList.toggle('hidden', mode !== 'login');
                els.registerForm.classList.toggle('hidden', mode !== 'register');
                if (els.authTitle) {
                    els.authTitle.textContent = mode === 'register' ? 'Criar conta' : 'Entrar';
                }
                setAuthFeedback('');
            }

            function openAuthModal(mode = 'login', message = '') {
                if (!els.authOverlay) return;
                switchAuthTab(mode);
                els.authOverlay.classList.remove('hidden');
                els.authOverlay.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
                if (message) {
                    setAuthFeedback(message, false);
                }
            }

            function closeAuthModal() {
                if (!els.authOverlay) return;
                els.authOverlay.classList.add('hidden');
                els.authOverlay.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
                setAuthFeedback('');
            }

            async function handleCheckout() {
                const cart = loadCart();
                if (!cart.length) {
                    alert('Carrinho vazio.');
                    return;
                }
                if (!currentUser) {
                    closeCart();
                    openAuthModal('login', 'Faça login para finalizar sua compra.');
                    return;
                }
                const items = cart
                    .map(item => ({ gameId: Number(item.gameId), quantity: item.qty || 1 }))
                    .filter(item => Number.isInteger(item.gameId) && item.gameId > 0);
                if (!items.length) {
                    alert('Sincronizando itens com o catalogo. Tente novamente.');
                    await loadCatalog();
                    upgradeCartFromBackend();
                    return;
                }
                try {
                    if (els.cartCheckout) {
                        els.cartCheckout.disabled = true;
                    }
                    const result = await api('/cart/checkout', {
                        method: 'POST',
                        body: JSON.stringify({ items })
                    });
                    showToast('Pedido registrado com sucesso!');
                    saveCart([]);
                    renderCart();
                    closeCart();
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Não foi possível concluir o checkout.');
                } finally {
                    if (els.cartCheckout) {
                        els.cartCheckout.disabled = false;
                    }
                }
            }

            async function loadCatalog() {
                try {
                    const response = await fetch(API_BASE + '/games');
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        backendGames = data;
                        gameIndex.clear();
                        backendGames.forEach(game => {
                            if (game && game.nome) {
                                gameIndex.set(game.nome.trim().toLowerCase(), game);
                            }
                        });
                        document.querySelectorAll('.card').forEach(syncCardWithBackend);
                        upgradeCartFromBackend();
                    }
                } catch (err) {
                    console.warn('Falha ao carregar catalogo do backend', err);
                }
            }

            if (els.navCart) {
                els.navCart.addEventListener('click', (e) => {
                    e.preventDefault();
                    openCart();
                });
            }
            if (els.cartOverlay) {
                els.cartOverlay.addEventListener('click', (e) => {
                    if (e.target === els.cartOverlay) {
                        closeCart();
                    }
                });
            }
            if (els.cartClose) {
                els.cartClose.addEventListener('click', closeCart);
            }
            if (els.cartClear) {
                els.cartClear.addEventListener('click', () => {
                    saveCart([]);
                    renderCart();
                });
            }
            if (els.cartCheckout) {
                els.cartCheckout.addEventListener('click', handleCheckout);
            }

            if (els.loginBtn) {
                els.loginBtn.addEventListener('click', () => openAuthModal('login'));
            }
            if (els.logoutBtn) {
                els.logoutBtn.addEventListener('click', async () => {
                    try {
                        await api('/auth/logout', { method: 'POST' });
                    } catch (err) {
                        console.warn('Falha ao encerrar sessão', err);
                    }
                    clearToken();
                    currentUser = null;
                    updateAuthUI();
                    showToast('Voce saiu da conta.');
                });
            }
            if (els.authClose) {
                els.authClose.addEventListener('click', closeAuthModal);
            }
            if (els.authOverlay) {
                els.authOverlay.addEventListener('click', (e) => {
                    if (e.target === els.authOverlay) {
                        closeAuthModal();
                    }
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && els.authOverlay && !els.authOverlay.classList.contains('hidden')) {
                    closeAuthModal();
                }
            });

            els.authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const mode = tab.dataset.authTab;
                    switchAuthTab(mode);
                });
            });

            if (els.loginForm) {
                els.loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const form = event.currentTarget;
                    const email = form.email.value.trim();
                    const password = form.password.value;
                    if (!email || !password) {
                        setAuthFeedback('Preencha e-mail e senha.');
                        return;
                    }
                    const submitBtn = form.querySelector('.auth-submit');
                    try {
                        submitBtn.disabled = true;
                        setAuthFeedback('Entrando...');
                        const data = await api('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify({ email, password })
                        });
                        setToken(data.token);
                        currentUser = { email: data.email };
                        updateAuthUI();
                        setAuthFeedback('Login realizado com sucesso!', true);
                        form.reset();
                        setTimeout(() => {
                            closeAuthModal();
                        }, 700);
                    } catch (err) {
                        setAuthFeedback(err.message || 'Não foi possível entrar.');
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }

            if (els.registerForm) {
                els.registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const form = event.currentTarget;
                    const email = form.email.value.trim();
                    const password = form.password.value;
                    if (!email || !password) {
                        setAuthFeedback('Preencha e-mail e senha.');
                        return;
                    }
                    const submitBtn = form.querySelector('.auth-submit');
                    try {
                        submitBtn.disabled = true;
                        setAuthFeedback('Criando conta...');
                        await api('/auth/register', {
                            method: 'POST',
                            body: JSON.stringify({ email, password })
                        });
                        form.reset();
                        setAuthFeedback('Conta criada! Faça login para continuar.', true);
                        switchAuthTab('login');
                    } catch (err) {
                        setAuthFeedback(err.message || 'Não foi possível criar a conta.');
                    } finally {
                        submitBtn.disabled = false;
                    }
                });
            }

            decorateCards();
            renderCart();
            refreshUser();
            loadCatalog();
        });
    </script>
    </body>
</html>
